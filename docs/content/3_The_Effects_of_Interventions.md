## 3 干预的效果

### 3.1 干预

许多统计研究的最终目标是预测干预措施的效果。例如，我们收集西部火灾相关因素的数据，实际上是要寻找可以用于预测的因素，以减少火灾的发生；当对一种新的癌症药物进行研究时，通过让患者服药以实施干预，观察患者用药后的反应；而当研究暴力电视节目与儿童的攻击性行为之间的相关性时，是想尝试确认少数儿童接触暴力电视节目的干预措施能否降低儿童的攻击性。

在统计学课程中常会提到“相关关系不是因果关系”。两个变量之间的关系并不仅仅只有一个变量引起另一个变量的变化（关于这个性质有一个著名例子：冰激凌销量的增加与暴力犯罪数目的增加是有关系的，不是因为冰激凌导致犯罪，而是因为冰激凌销量和暴力犯罪都在炎热天气中更常见）。因此，随机对照试验被认为是统计学中的黄金准则。在一个正确的随机对照试验中，除了输入变量，所有影响输出变量的因素要么是不变的，要么是随机变化的，因此输出变量的任何改变必然由这一个输入变量引起。

不幸的是，很多问题不适合用随机对照试验来解决。我们不能控制天气，所以无法将引起火灾的变量随机化；研究暴力电视节目的时候，虽可以随机选取参与者，但很难有效地控制每个孩子电视的行为，而且几乎不可能知道我们对孩子的控制是否有效；甚至在随机药物试验中，也会出现很多问题，参与者退出了、没有吃药或者弄虚作假吃药。

在随机对照试验不可行的情况下，研究人员实施观察性研究，他们仅仅记录数据，而不是擦除数据。这种研究方法的问题在于很难将因果关系从相关关系中提取出来。常识告诉我们，对冰激凌的销量进行干预，不会影响犯罪的数目，但事实不都是这么清晰。例如，温尼伯大学最近的一项研究表明，青少年过度发短信与（知识）“肤浅”相关。有媒体证实说，发短信使青少年更加肤浅（从干预角度说，对青少年进行干预，使他们减少发短信的数量，从而不让他们那么“肤浅”）。但是，这个试验没有证明任何事情，可能是肤浅使青少年发短信更多；也可能肤浅和短信过度是由一个共同因素引起的，例如基因，如果可能的话，对该基因因素进行干预，可以避免这两个方面的问题。

对一个变量进行干预与以该变量为条件的区别是很明显的。当干预模型中的一个变量时，我们固定这个变量的值，这意味着改变了系统，其他变量的值通常会因此发生变化。当以一个变量为条件时，我们不做任何改变；仅仅关注问题的子集，在这个子集内，变量的值都是我们感兴趣的，这里改变的是我们对世界的看法，而不是世界本身。

例如，图3.1展示了冰激凌销量例子的图模型， $X$ 表示冰激凌销量， $Y$ 表示犯罪率， $Z$ 表示温度。当采取干预措施、固定变量的值时，意味着削弱了该变量为响应其他变量而变化的自然趋势。这相当于在图模型上进行一种处理，即删除指向该变量的所有边。如果采取的干预措施是降低冰激凌销量（比如，关闭所有的冰激凌店），将得到如图3.2所示的图模型。检验图3.2中的相关性可以发现，犯罪率与冰激凌的销量完全独立（即不相关），这是因为后者不再与温度（2）相关。换句话说，即使改变了固定值的水平，这个变化也不会传递到变量 $Y$ （犯罪率）。也就是说，干预一个变量会产生一种与以变量为条件完全不同的依赖模式。此外，以变量为条件可以用第1章中描述的方法直接从数据集中获得，而干预的变化依赖于因果图的结构。对于任何给定的干预，可以根据图模型来确定应该删除哪些边。

![fig_3.1](../images/fig_3.1.png)

![fig_3.2](../images/fig_3.2.png)

我们在符号上区分变量 $X$ 自然地取值 $x$ 的情况和固定 $X$ 取值 $x$ 的情况，后者用 $do(X=x)$ 来表示。因此， $P(Y=y\mid X=x)$表示在 $X=x$ 的条件下 $Y=y$ 的概率： $P(Y=y\mid do(X=x))$ 表示通过干预使 $X=x$ 时 $Y=y$ 的概率。以分布的术语来说， $P(Y=y\mid X=x)$ 反映了在 $X$ 的值都是 $x$ 的个体上 $Y$ 的总体分布；另一方面， $P(Y=y\mid do(X=x))$ 反映了如果群体中的每个个体均将 $X$ 值固定为 $x$ 时， $Y$ 的总体分布。类似地，用 $P(Y=y\mid do(X=x),Z=z)$ 表示对于给定的 $Z=z$ ，干预 $do(X=x)$ 得到的分布中 $Y=y$ 的条件概率。

利用do-表达式和图模型，可以将因果关系从相关关系中分解出来。在这一章剩下的部分，我们将学习一种通过单纯地观察数据就能神奇地分解出因果关系的方法，当然，首先要假设图是实际问题的有效表述。箭要注意的是，默认假设的干预不会造成其他影响，也就是说，当对一个个体给变量 $X$ 分配值 $x$ 时，不会直接改变其他变量的值。比如，给一个患者分配一种药物和违背了他的宗教信仰强迫其服用药物，在恢复上可能有不同的效果，当改变了其他变量的值时，这些改变必须在模型中明确地表示出来。

### 3.2 校正公式

冰激淋的例子代表了一种极端的情况，在这个例子中， $X$ 和 $Y$ 之间的相关性从因果角度完全是假设的，因为从 $X$ 到 $Y$ 没有因果路径，但现实生活中大多数情况并不那么明确。为了探讨一个更现实的情况，我们来分析图3.3，其中 $X$ 代表使用药物， $Y$ 代表痊愈， $Z$ 代表性别， $Z$ 和 $X$ 都对 $Y$ 有影响，这个模型实际上反映的就是辛音森悖论。为了确定药物在人群中的有效性，设想一种假设性的干预指施，即对整个人人统一致服用这种药物，并与补充干预下的痊愈率进行比较，补充干预指阳止每个服用药物。用 $do(X=1)$ 表示第一种干预，用 $do(X=0)$ 表示第二种干预，现在要估计它们的差异。



$$
P(Y=1\mid do(X=1))-P(Y=1\mid do(X=0))\tag{3.1}
$$



该差异称为“因果效应差异”或“平均因果效应”（average causal effect, ACE）。一般地，如果 $X$ 和 $Y$ 都能取多个值，我们希望使 $x$ 和 $y$ 取遍 $X$ 和 $Y$ 可以取得的任意两个值来预测综合因果效应 $P(Y=y\mid do(X=x))$ ，例如，$X$ 可能是药物的剂量， $Y$ 可能是患者的血压。

![fig_3.3](../images/fig_3.3.png)

根据基本规则可知，在没有因果关联的情况下，当然无法从数据集本身估计因果效应。这就是辛普森悖论的教训，数据本身甚至不足以确定药物的作用是正面的还是负面的。但是，借助图 3.3 的图模型，可以从数据中计算因果效应的大小。为此，可以通过对图进行处理的方式模拟干预（见图 3.4，该模型中全体人群都服用了该药物，结果为操纵概率 $P_m$ ），就像在冰激凌的例子中所做的那样。因果效应 $P(Y=y\mid do(X=x))$ 与图3.4中修改后模型的条件概率 $P_m(Y=y\mid X=x)$ 相等。$P_m$ 代表修改后模型中的概率，因此也被称为操纵概率（这种处理方法也解决了是应该分析总体数据，还是应该分析以变量 $z$ 的值划分的子表才能得到正确答案的问题。当通过干预来确定答案时，只需处理一个表就行了）。

![fig_3.4](../images/fig_3.4.png)

计算因果效应的关键在于观察操纵概率 $P_m$ ，其具有 $P$ （图 3.3 中干预前模型的原始概率）的两个基本属性。第一，边际概率 $P(Z)$ 在干预后不变，因为移除 $Z$ 到 $X$ 的箭头不会影响确定 $Z$ 值的过程。在辛普森悖论的例子中，这意味着干预前后男性患者和女性患者的比例不会发生变化。第二，条件概率 $P(Y=y\mid Z=z,X=x)$ 是不变的，因为无论 $X$ 是自然变化还是被故意操控发生变化， $Y$ 对 $X$ 和 $Z$ 的响应函数 $Y=f(x,z,u_Y)$ 都不变。因此，可以给出两个不变性方程：



$$
P_m(Y=y\mid Z=z,X=x)=P(Y=y\mid Z=z,X=x)
$$

$$
P_m(Z=z)=P(Z=z)
$$



由于 $Z$ 和 $X$ 在修改后的模型中是d-分离的，因此在干预分布中也是独立的，这说明 $P_m(Z=z\mid X=x)=P_m(Z=z)=P(Z=z)$ 综上所述，可以得到：



$$
P(Y=y\mid do(X=x))=P_m(Y=y\mid X=x)(\text{由定义})\tag{3.2}
$$

$$
=\sum_zP_m(Y=y\mid X=x,Z=z)P_m(Z=z\mid X=x)\tag{3.3}
$$

$$
=\sum_zP_m(Y=y\mid X=x,Z=z)P_m(Z=z)\tag{3.4}
$$



式（3.3）由全概率公式得到，即以 $Z=z$ 的所有值为条件求条件概率，然后求和，正如式（1.9）一样，而式（3.4）则利用了修改后模型中 $Z$ 和 $X$ 的独立性得到。

最后，利用不变性关系，得到一个以干预前概率表示的因果效应公式



$$
P(Y=y\mid do(X=x))=\sum_zP(Y=y\mid X=x,Z=z)P(Z=z)\tag{3.5}
$$



式（3.5）称为校正公式，它对每一个 $Z$ 的值 $z$ 计算了 $X$ 和 $Y$ 之间的关系，然后对这些值求平均值，这个过程被称为“对 $Z$ 的校正”或“对 $Z$ 的控制”。

式（3.5）的右边可以直接从数据中估算得到，这是因为它只包括条件概率，每个条件概率可以用第1章中描述的方法来计算。还应注意，随机对照试验中不需要做这样的校正计算，因为在这一试验中，数据是由具有如图3.4所示的模型生成的。因此，不管影响 $Y$ 的因素 $Z$ 是什么， $P_m=P$ 都成立。因此，对于校正公式（3.5）的推导形式化地证明了：随机试验可用于定量估计 $P(Y=y\mid do(X=x))$ 。实际上，研究人员也使用该公式对随机试验的数据进行校正，以减少采样误差（Cox, 1958）。

为了演示校正公式的作用，我们将其应用于辛普森悖论。设 $X=1$ 表示患者用药， $Z=1$ 表示男性患者， $Y=1$ 表示患者痊愈。于是有：



$$
\begin{aligned}
P(Y=1\mid do(X=1))=&P(Y=1\mid X=1,Z=1)P(Z=1)+\\
&P(Y=1\mid X=1,Z=0)P(Z=0)
\end{aligned}
$$



使用表1.1中给出的数据，可以得到：



$$
P(Y=1\mid do(X=1))=\frac{0.93\times(87+270)}{700}+\frac{0.73\times(263+80)}{700}=0.832
$$



同理，



$$
P(Y=1\mid do(X=0))=\frac{0.87\times(87+270)}{700}+\frac{0.69\times(263+80)}{700}=0.7818
$$



因此，比较服用药物（ $X=1$ ）的效果和不服用药物（ $X=0$ ）的效果，有：



$$
ACE=P(Y=1\mid do(X=1))-P(Y=1\mid do(X=0))=0.832-0.7818=0.0502
$$



这表明服药具有明显的积极作用。对平均因果效应（ACE）更通俗的解释是，如果将每位患者在服用药物和不服用药物的情况下进行比较，那么平均因果效应反映的是在总体人群中痊愈率比例的差异。

校正公式指示，以性别为条件，分别计算男性患者和女性患者服用药物的痊愈率，然后根据男性患者和女性患者在全体受试者中的比例，对结果求平均值。该公式还指出，可以不直接使用群体数据 $P(Y=1 | X=1)$ 和 $P(Y=1 | X=0)$ ，因为这些群体数据可能会导致错误地判断该药物对全体受试者具有负面作用。

这些简单的例子可能会让读者产生这样的印象：每当我们面临是否使用第三个变量 $Z$ 进行条件分析的困境时，相比非特异性分析，校正公式更倾向于 Z-特异性分析。但事实并非如此。回想表 1.2 中辛普森悖论的血压示例。在那个例子中，我们认为更明智的方法是不使用血压进行条件分析，而是直接测试无条件的群体数据。那么，校正公式如何应对这种情况呢？

图3.5中的图表示了血压例子中的因果关系，与图3.3不同之处是 $X$ 和 $Z$ 之间的箭头反转了，这反映了治疗对血压有影响的事实。图3.5中没有显示外生变量，这意味着这些外生变量是相互独立的。现在来评估与这个模型相关联的因果效应 $P(Y=y\mid do(X=1))$ ，就像处理性别例子一样。首先模拟干预，然后计算模拟干预产生的校正公式。在图模型中，通过切断进入干预变量 $X$ 的所有箭头来模拟干预。但在这个例子中，因为图3.5中 $X$ 没有父节点，所以没有箭头进入 $X$ 。这意味着不需要修改这个图模型；这种获得数据的情况类似于服药分配“好像是随机的”。如果有一个因素使受试者偏爱或拒绝治疗，这个因素就应该出现在模型中，由于没有这样一个因素，因此可以认为 $X$ 是随机变化的。

![fig_3.5](../images/fig_3.5.png)

在这种条件下，干预后的图与原始图相同（没有箭头被删除），校正公式归约为



$$
P(Y=y\mid do(X=x))=P(Y=y\mid X=x)
$$



这个式子可以将校正公式的校正变量设为空集得到。显然，如果试图校正血压对于结果的影响（对应的模型是血压引发人们服药），我们会得到一个不正确的估计。

#### 3.2.1 校正还是不校正

我们现在需要确定，哪个变量或哪组变量最可以合理地用于校正公式中。导出校正公式的干预过程说明， $Z$ 应与 $X$ 的父节点一致。因为当通过外部操作固定 $X$ 的值时，我们消除的是这些父节点的影响。将 $X$ 的父节点记作 $PA(X)$ ，可以得到一般化的校正公式，并将其总结为下面这条规律：

**规则 3.2.1（因果效应规则）** 给定一个图 $G$ ，设变量 $X$ 的父节点集合为 $PA$ ，则 $X$ 对 $Y$ 的因果效应为：



$$
P(Y=y\mid do(X=x))=\sum_zP(Y=y\mid X=x,PA=z)P(PA=z)\tag{3.6}
$$



其中， $z$ 的取值范围是 $PA$ 中变量可能取值的所有组合。

如果将式（3.6）求和公式乘以概率 $P(X=x\mid PA=z)$ ，再除以这个概率，这样可以得到以联合概率表示的形式：



$$
P(y\mid do(x))=\sum_z\frac{P(X=x,Y=y,PA=z)}{P(X=x\mid PA=z)}\tag{3.7}
$$



式（3.7）明确显示了 $X$ 的父节点在预测干预结果中所起的作用。因素 $P(X=x\mid PA=z)$ 被称为倾向分数，第 3.5 节将讨论 $P(y\mid do(x))$ 这种表达式的优点。

现在，我们了解了因果图在解决辛普森悖论中的作用。更一般地，利用图即可单纯地从统计数据中预测因果关系。根据图来确定 $X$ 的父节点，在不进行试验的条件下，这一组变量足够用来确定 $X$ 的值或值的概率。

使用图及其基本假设，能够在纯观测数据中识别出因果关系，这是令人吃惊的。但是，基于前面的讨论，读者可能会认为图的作用是相当有限的，一旦识别出了 $X$ 的父节点，即可应用校正公式刻板地评估因果效应，图剩下的部分就可以被舍弃了。在下一节将看到事情可能并不是这么简单，在大多数实际的例子中， $X$ 的父节点集合会包含不可观测的变量，这使我们无法计算校正公式中的条件概率。幸运的是，我们将在后续章节中看到，可以对模型中的其他变量进行校正，从而代替 $PA(X)$ 中不可观测的变量。

#### 思考题

#### 3.2.1

参考思考题 1.5.2（图 1.10）及其中列出的参数。

(a) 通过对模型进行模拟干预 $do(x)$ ，对 $X$ 和 $Y$ 所有的值计算 $P(y\mid do(x))$ 。

(b) 用校正公式(3.5)，对 $X$ 和 $Y$ 所有的值计算 $P(Y\mid do(x))$ 。

(c) 计算平均因果效应： $ACE=P(y_1\mid do(x_1))-P(y_1\mid do(x_0))$ ，并与风险差（risk difference，RD）比较： $RD=P(y_1|x_1)−P(y_1|x_0)$ 。ACE和RD有什么不同，哪个参数的值可能使两者的差异最小化？

(d) 找到一个参数组合，使这个例子变成辛普森悖论（正如思考题1.5.2(c)一样），并解释药物的总体因果效应可以从分类数据中获得。

#### 3.2.2 多重干预和截断乘积规则

在推导校正公式时，假设仅对单个变量 $X$ 进行干预，使 $X$ 不与其父节点连接，以模拟干预后 $X$ 不受影响的情形。有关社会和医疗政策决策问题偶尔会涉及多重干预措施，例如同时指定几个变量的值，或者控制一个变量随时间而变。为了表示多重干预，可以使用在 1.5.2 节讨论的方法，简单地对图模型产生的联合分布进行乘积分解。根据乘积分解法则，图 3.3 中的模型在干预前的分布可用乘积的形式给出：



$$
P(x,y,z)=P(z)P(x\mid z)P(y\mid x,z)\tag{3.8}
$$



而干预后的分布由图 3.4 的模型确定，以乘积的形式表示为



$$
P(z,y\mid do(z))=P_m(z)P_m(y\mid x,z)=P(z)P(y\mid x,z)\tag{3.9}
$$



在这个公式中，由于固定 $X=x$ 后， $X$ 无父节点了，因此从乘积中删除了因子 $P(x)$ 。这与校正公式一致，因为在评估 $P(y\mid do(x))$ 时，需要对 $z$ 求和，所以校正公式为



$$
P(y\mid do(x))=\sum_zP(z)P(y\mid x,z)
$$



这与式（3.5）一致。

这也启发我们将校正公式推广到多重干预，即将一组变量 $X$ 的值固定为常数的干预，简单写下干预前分布的乘积分解，并且删去与干预集 $X$ 中的变量相对应的所有因素，有



$$
P(x_1,x_2,\dots,x_n\mid do(x))=\prod_iP(x_i\mid pa_i)\quad\text{( $i$ 取所有不在 $X$ 中的 $X_i$ )}
$$



这被称为截断公式或g-公式。为了说明，假设干预如图2.9所示的模型，将 $X$ 设置为 $x$ ， $Z_3$ 设置为常数 $z_3$ ，则干预后模型中其他变量的分布为



$$
P(z_1,x_2,w,y\mid do(X=x,Z_3=x_3))=P(z_1)P(z_2)P(w\mid x)P(y\mid w,z_3,z_2)
$$



其中，从乘积公式中删除了因子 $P(x\mid z_1,x_3)$ 和 $P(z_3\mid z_1,z_2)$ 。

有趣的是，结合式（3.8）和式（3.9），得到干预前和干预后分布之间的简单关系为



$$
P(z,y\mid do(x))=\frac{P(x,y,z)}{P(x\mid z)}\tag{3.10}
$$



它告诉我们，为了预测在分布 $P(x,y,z)$ 下非试验数据对 $X$ 干预的效果，我们仅需要知道所有的条件概率 $P(x\mid z)$ 即可。

### 3.3 后门准则

根据3.2节讨论可以得到结论：当试图确定一个变量对另一个变量的因果效应时，可以对该变量的父节点变量进行校正。但我们知道或者相信变量通常有不可观察的父节点，即虽然该父节点在途中表现出来了，但是节点的值却无法得到。在这些情况下，需要找到一个替代的变量集合用于校正。

这一定困境引发了一个更深层次的统计问题：在什么条件下，因果关系允许我们从被动观察得到的非干预数据中计算一个变量对另一个变量的因果效应呢？既然我们已经决定用图的方法表示因果关系，那么这个问题就变为一个图论问题：在什么条件下，因果图结构足以用来计算给定数据的因果效应？

这个问题的答案很长，也很重要，我们将用本章剩下的内容来说明。实际上，用于计算因果效应的一个非常重要的工具就是一个简单的准则——后门准则。使用后门准则可以确定，对于由有向无环图表示的因果模型中的任何两个变量 $X$ 和 $Y$ ，应该以模型中的某些变量 $Z$ 为条件来寻找 $X$ 与 $Y$ 之间的因果关系。

**定义 3.3.1（后门准则）** 给定有向无环图中的一对有序变量 $(X, Y)$ 。如果变量集合 $Z$ 满足：$Z$ 中没有 $X$ 的后代节点，且 $Z$ 阻断了 $X$ 与 $Y$ 之间的每条含有指向 $X$ 的路径，则称 $Z$ 满足关于 $(X, Y)$ 的后门准则。

如果变量集合 $Z$ 满足 $(X, Y)$ 的后门准则，那么 $X$ 对 $Y$ 的因果效应可以由以下公式计算：



$$
P(Y=y\mid do(X=x))=\sum_zP(Y=y\mid X=x,Z=z)P(Z=z)
$$



这类似于前面 3.2 节对 $PA(X)$ 做的校正（注意： $PA(X)$ 总是满足后门准则）。

后门准则背后的逻辑很明确，一般来说，我们希望以这样的节点集合 $Z$ 为条件：

1. 阻断 $X$ 和 $Y$ 之间的所有伪路径，
2. 保持所有从 $X$ 到 $Y$ 的有向路径不变，
3. 不会产生新的伪路径。

当试图寻找 $X$ 对 $Y$ 的因果效应时，希望被纳入条件的节点能阻断任何含有指向 $X$ 的“后门”路径，这样的路径可能使 $X$ 和 $Y$ 相关但并不传递 $X$ 产生的因果效应。如果不阻断它们，它们会混淆 $X$ 对 $Y$ 的效应。因此，应该以阻断后门路径为条件，以满足第一个要求。然而，并不会以 $X$ 的任何后代节点为条件，因为对 $X$ 的干预会影响 $X$ 的后代节点，从而影响 $Y$ ，以 $X$ 的后代为条件可能会阻断这些路径。因此，不以 $X$ 的后代节点为条件就符合第二个要求。最后，为了遵守第三个要求，应该避免以任何对撞节点为条件，否则会解除阻断，从而产生 $X$ 与 $Y$ 之间的一条新路径。排除 $X$ 后代节点的要求也能避免以 $X$ 和 $Y$ 之间共同节点的后代节点为条件（例如，图2.4中的对撞节点 $W$ ），以这些后代节点为条件会干扰因果关系在 $X$ 和 $Y$ 之间的传递，正如以它们的父节点为条件时那样。

下面以图3.6所示的具体案例为例，说明这些要求在实际应用中的含义。

![fig_3.6](../images/fig_3.6.png)

这⾥，试图获取药物（ $K$ ）对痊愈率（ $Y$ ）的因果效应，同时还测量了对痊愈率有影响的体重 $W$ 。此外，我们知道经济社会地位（ $Z$ ）同时影响患者体重和患者对接受治疗的选择，但是在这个研究中并没有关于经济社会地位的统计数据。

我们搜索满足从 $X$ 到 $Y$ 后门准则的观察变量。观察图 3.6 可发现：节点 $W$ （⾮ $X$ 的后代）阻断后门路径 $X\leftarrow Z\to W\to Y$ 。因此， $W$ 满足后门准则。只要因果关系符合如图3.6所示的图模型，校正 $W$ 都会得到 $X$ 对 $Y$ 的因果效应，使用校正公式，有


$$
P(Y=y\mid do(X=x))=\sum_wP(Y=y\mid X=x,W=w)P(W=w)
$$


只要 $W$ 是可观测的，上述求和式就可以通过观察数据估算出来。







































